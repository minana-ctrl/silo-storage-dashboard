<!-- f8235e71-0ae0-44c4-8073-35fd2c28b99c dfc3d54f-c531-413b-a183-d63149dc356e -->
# Implement Conversations Page with Voiceflow Transcripts API

## Overview

Implement the Conversations page as a 3-column master-detail layout that pulls **real conversation transcripts** from the Voiceflow Transcripts API, as documented in [Voiceflow Transcripts API - Get All Project Transcripts](https://docs.voiceflow.com/reference/transcriptpubliccontroller_searchbyprojectid), and displays turn-by-turn dialogs.

## Architecture Decisions

- **Frontend stack**: Next.js App Router (existing), TypeScript, Tailwind CSS.
- **Data source**: Voiceflow Transcripts API ("Get All Project Transcripts" and "Get Transcript with Logs") instead of pure mock data.
- **Security**: All Voiceflow calls go through Next.js API routes so the `VF.DM` API key never reaches the browser.
- **Scalability**: Use server pagination parameters (e.g. `limit`, `cursor`) when calling the transcripts endpoint to handle large transcript volumes.

## Data Strategy

- **Primary source**: Call `POST https://analytics-api.voiceflow.com/v1/transcript/project/{projectID}` with the `authorization: VF.DM...` header to fetch transcript summaries for the project, per [Voiceflow Transcripts API - Get All Project Transcripts](https://docs.voiceflow.com/reference/transcriptpubliccontroller_searchbyprojectid).
- **Dialog fetch**: For a selected transcript, call the corresponding "Get Transcript with Logs" endpoint (from the same Transcripts API group) to retrieve the full turn-by-turn dialog.
- **Fallback**: If environment variables are missing or the Voiceflow API fails, fall back to a small in-memory mock dataset so the UI still renders.

## Implementation Steps

### 1. Define Types

Create `types/conversations.ts` with:

- **`TranscriptSummary`**: `{ id, userId, platform, createdAt, lastInteractionAt, tags, properties, firstUserMessagePreview }` (mapped from the Transcripts API response fields).
- **`TranscriptTurn` / `Message`**: `{ id, role: 'user' | 'assistant' | 'system', content, timestamp }` representing each dialog turn.
- **`ConversationFilters`**: `{ query, platform?, startTime?, endTime?, tag? }` for search and filtering.

### 2. Voiceflow Transcripts Client

Create `lib/voiceflowTranscripts.ts` (or extend `lib/voiceflow.ts`) to wrap the HTTP calls:

- **`fetchTranscripts(filters)`**: Calls `POST /v1/transcript/project/{projectID}` on `https://analytics-api.voiceflow.com` with body and query parameters derived from `ConversationFilters` and pagination (`limit`, `cursor`), returning a typed `TranscriptSummary[]` plus pagination metadata.
- **`fetchTranscriptDialog(transcriptId)`**: Calls the "Get Transcript with Logs" endpoint to return the ordered list of `TranscriptTurn` for that transcript.
- Map raw Voiceflow fields into our internal types, keeping the raw payload available if needed for advanced inspector features later.

### 3. Next.js API Route for Conversations

Create `app/api/conversations/route.ts` to proxy the Voiceflow API:

- **`GET` handler** for transcript summaries:
- Reads `PROJECT_ID` and `API_KEY` from environment variables.
- Accepts query params for `q` (search), `platform`, `startTime`, `endTime`, `tag`, `limit`, `cursor`.
- Calls `fetchTranscripts` and returns a normalized JSON structure `{ items: TranscriptSummary[], nextCursor?: string }`.
- **`GET` handler for a single transcript dialog** (either as a nested route `app/api/conversations/[id]/route.ts `or by `id` query param):
- Calls `fetchTranscriptDialog(id)` and returns `{ messages: TranscriptTurn[] }`.
- Handles errors with clear HTTP status codes and messages; uses a small mock response when the Voiceflow API is not configured.

### 4. UI Components

Create or update components under `components/`:

- **`ConversationList.tsx`** (left column, ~25% width):
- Calls `/api/conversations` on mount (and on filter changes) to load transcript summaries.
- Renders search input ("Search userâ€¦"), time filter (Last 7/14/30/90 days), filter icon, export icon.
- Shows user name/ID, platform icon, timestamp, and preview text.
- Highlights the selected conversation with a red border or light red background.
- Supports infinite scroll or "Load more" using `nextCursor`.
- **`ChatInterface.tsx`** (center column, ~50% width):
- Receives the selected `TranscriptSummary` and fetches `/api/conversations/{id}` to get messages.
- Header shows current user ID and pill tags (`[Join Discord] [Roadmap]` as spec examples, plus any tags from the transcript).
- Message area renders a list of `MessageBubble` components.
- Input at bottom is a disabled text field with placeholder "What is ChatDash?" to match read-only view.
- **`MessageBubble.tsx`**:
- Renders a single message turn.
- **User messages**: red bubble (`#ec2f2f`) with white text, right-aligned.
- **AI messages**: white bubble with grey border, left-aligned.
- Uses `Metropolis` for body text.
- **`ConversationInspector.tsx`** (right column, ~25% width):
- Header: "Actions".
- Toggles (switch components) for **Intent Confidence** and **Debug Messages** (UI only for now, wired to local state).
- `textarea` for "Leave a note" bound to local state; optionally persisted in `localStorage` keyed by transcript ID.
- **`PlatformIcon.tsx`**:
- Small reusable icon component for Web / WhatsApp based on transcript metadata.

### 5. Wire Up `app/conversations/page.tsx`

Update `app/conversations/page.tsx` to use the new components:

- Use a 3-column grid layout (`grid grid-cols-[1.5fr_3fr_1.5fr]` or similar) within the existing dashboard shell.
- Manage top-level React state for:
- `selectedTranscriptId`
- Current filters (date range, search text, platform).
- Pass state and callbacks into `ConversationList`, `ChatInterface`, and `ConversationInspector`.
- Show sensible loading and empty states (e.g., "No conversations found for this range").

### 6. Styling and Theming

- Ensure colors, fonts, and components follow the tokens defined in `Dashboard.MD` and `globals.css`:
- Primary red `#ec2f2f` for active items and user message bubbles.
- Black or white sidebar and backgrounds per existing layout.
- `font-heading` (Robostic) for headers and key labels; `font-body` (Metropolis) for transcript content.
- Reuse card and button utility classes where possible (`.card`, `.btn-primary`).

### 7. Optional Enhancements (Future)

- Add column to Conversation List for key metrics per transcript (message count, duration) by leveraging additional fields from the Transcripts API.
- Support server-side filtering by tags and custom transcript properties using the Transcript Properties API.
- Add an "Export" button that downloads the currently selected transcript as JSON or CSV via the backend.

## Files to Create/Modify

- **Create**: `types/conversations.ts`
- **Create**: `lib/voiceflowTranscripts.ts` (or extend `lib/voiceflow.ts` with transcript helpers)
- **Create**: `app/api/conversations/route.ts` (and optionally `app/api/conversations/[id]/route.ts`)
- **Create**: `components/ConversationList.tsx`
- **Create**: `components/ChatInterface.tsx`
- **Create**: `components/ConversationInspector.tsx`
- **Create**: `components/MessageBubble.tsx`
- **Create**: `components/PlatformIcon.tsx`
- **Modify**: `app/conversations/page.tsx`

### To-dos

- [ ] Define TypeScript types for transcript summaries, dialog turns, and conversation filters in `types/conversations.ts`.
- [ ] Implement Voiceflow Transcripts API client helpers in `lib/voiceflowTranscripts.ts` (or extend `lib/voiceflow.ts`) for listing transcripts and fetching a single transcript dialog.
- [ ] Create Next.js API routes under `app/api/conversations` to proxy the Voiceflow Transcripts API, handle filters and pagination, and normalize responses.
- [ ] Build ConversationList, ChatInterface, MessageBubble, ConversationInspector, and PlatformIcon components to render the 3-column Conversations layout.
- [ ] Update `app/conversations/page.tsx` to compose the new components, manage selection and filters, and apply dashboard layout styling.